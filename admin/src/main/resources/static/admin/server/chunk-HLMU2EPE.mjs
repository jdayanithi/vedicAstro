import './polyfills.server.mjs';
import{d as f}from"./chunk-23SLAFQR.mjs";import{Fa as g}from"./chunk-5MMNTMZA.mjs";import{$ as l,Da as m,Mc as r,Rc as h,T as u,W as p,aa as c,g as s}from"./chunk-Y2VJ442J.mjs";var b=class a{constructor(t,e){this.http=t;this.router=e;this.checkSession()}isAuthenticated=new s(!1);currentUserRole=new s(null);currentUser=new s(null);platformId=c(m);tokenExpirationTimer;isLoggedIn$=this.isAuthenticated.asObservable();userRole$=this.currentUserRole.asObservable();currentUser$=this.currentUser.asObservable();checkSession(){if(r(this.platformId)){let t=localStorage.getItem("token"),e=this.getSession();if(t&&e){this.isAuthenticated.next(!0),this.currentUserRole.next(e.role),this.currentUser.next(e);try{let o=JSON.parse(atob(t.split(".")[1])).exp*1e3,n=Date.now();o>n?this.autoLogoutTimer(o-n):this.logout()}catch{this.logout()}}}}autoLogoutTimer(t){this.tokenExpirationTimer&&clearTimeout(this.tokenExpirationTimer),this.tokenExpirationTimer=setTimeout(()=>{this.logout()},t)}getSession(){if(r(this.platformId)){let t=localStorage.getItem("session");return t?JSON.parse(t):null}return null}getCurrentUser(){return this.getSession()}login(t,e){return this.http.post(`${g.apiUrl}/login/validate`,{username:t,password:e}).pipe(u(i=>{if(r(this.platformId)){localStorage.setItem("token",i.token),localStorage.setItem("session",JSON.stringify(i));try{let n=JSON.parse(atob(i.token.split(".")[1])).exp*1e3;this.autoLogoutTimer(n-Date.now())}catch(o){console.error("Error setting auto logout timer:",o)}}this.isAuthenticated.next(!0),this.currentUserRole.next(i.role),this.currentUser.next(i)}))}register(t){return this.http.post(`${g.apiUrl}/register`,t)}logout(){r(this.platformId)&&(localStorage.removeItem("token"),localStorage.removeItem("session"),this.tokenExpirationTimer&&(clearTimeout(this.tokenExpirationTimer),this.tokenExpirationTimer=null)),this.isAuthenticated.next(!1),this.currentUserRole.next(null),this.currentUser.next(null),this.router.navigate(["/auth/login"])}getToken(){return r(this.platformId)?localStorage.getItem("token"):null}static \u0275fac=function(e){return new(e||a)(l(h),l(f))};static \u0275prov=p({token:a,factory:a.\u0275fac,providedIn:"root"})};export{b as a};
